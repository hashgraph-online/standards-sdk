<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Counter HashLink Demo</title>

    <!-- WordPress Dashicons for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/dashicons/0.9.0/css/dashicons.min.css"
    />

    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f0f0f0;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin: 0 0 10px;
        color: #23282d;
      }

      .subtitle {
        color: #666;
        font-size: 18px;
      }

      .demo-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .demo-section h2 {
        margin-top: 0;
        color: #23282d;
        border-bottom: 2px solid #0073aa;
        padding-bottom: 10px;
      }

      .demo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 30px;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 20px 0;
        display: none;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      .status.loading {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
        display: block;
      }

      .code-block {
        background: #f4f4f4;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 14px;
        overflow-x: auto;
      }

      .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 20px;
        background: #0073aa;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background: #005a87;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .info-box {
        background: #f0f8ff;
        border: 1px solid #b8daff;
        padding: 15px;
        border-radius: 4px;
        margin: 20px 0;
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .metric {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        text-align: center;
      }

      .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #0073aa;
      }

      .metric-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Counter HashLink Demo</h1>
        <p class="subtitle">
          Interactive demonstration of HCS-12 HashLinks on Hedera
        </p>
      </header>

      <!-- Status Messages -->
      <div id="status" class="status"></div>

      <!-- Demo Section 1: Basic Counter -->
      <div class="demo-section">
        <h2>Basic Counter Example</h2>
        <p>A simple counter with increment and decrement functionality.</p>

        <div id="basic-counter"></div>

        <div class="info-box">
          <strong>Features demonstrated:</strong>
          <ul>
            <li>WASM action execution</li>
            <li>Event binding to UI elements</li>
            <li>Real-time state updates</li>
          </ul>
        </div>
      </div>

      <!-- Demo Section 2: Multiple Counters -->
      <div class="demo-section">
        <h2>Multiple Counter Instances</h2>
        <p>
          Multiple counter instances with shared action but independent state.
        </p>

        <div class="demo-grid">
          <div id="counter-1"></div>
          <div id="counter-2"></div>
          <div id="counter-3"></div>
        </div>
      </div>

      <!-- Demo Section 3: Advanced Features -->
      <div class="demo-section">
        <h2>Advanced Counter Features</h2>
        <p>Counter with multiply operation and history tracking.</p>

        <div id="advanced-counter"></div>

        <div class="metrics">
          <div class="metric">
            <div class="metric-value" id="total-operations">0</div>
            <div class="metric-label">Total Operations</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="highest-value">0</div>
            <div class="metric-label">Highest Value</div>
          </div>
          <div class="metric">
            <div class="metric-value" id="action-latency">0ms</div>
            <div class="metric-label">Action Latency</div>
          </div>
        </div>
      </div>

      <!-- Demo Section 4: Developer Tools -->
      <div class="demo-section">
        <h2>Developer Tools</h2>

        <div class="controls">
          <button onclick="loadAssembly()">Load Assembly</button>
          <button onclick="inspectState()">Inspect State</button>
          <button onclick="exportState()">Export State</button>
          <button onclick="resetAll()">Reset All</button>
        </div>

        <div
          id="dev-output"
          class="code-block"
          style="margin-top: 20px; display: none"
        ></div>
      </div>
    </div>

    <!-- HashLink SDK -->
    <script src="../../dist/hashlink-client.js"></script>

    <script>
      // Global variables
      let client;
      let assembly;
      let metrics = {
        totalOperations: 0,
        highestValue: 0,
        lastLatency: 0,
      };

      // Initialize HashLink client
      async function initializeClient() {
        showStatus('loading', 'Initializing HashLink client...');

        try {
          // Initialize client (would use real credentials in production)
          client = new HashLinkClient({
            network: 'testnet',
            // In production, credentials would be handled securely
            mock: true, // Using mock mode for demo
          });

          await client.initialize();
          showStatus('success', 'HashLink client initialized successfully!');

          // Load counter assembly
          await loadAssembly();
        } catch (error) {
          showStatus('error', `Initialization failed: ${error.message}`);
          console.error(error);
        }
      }

      // Load assembly from deployment
      async function loadAssembly() {
        showStatus('loading', 'Loading counter assembly...');

        try {
          // In production, this would load from the actual assembly ID
          assembly = await client.loadAssembly('counter-assembly-v1');

          showStatus('success', 'Assembly loaded successfully!');

          // Render counters
          await renderCounters();
        } catch (error) {
          showStatus('error', `Failed to load assembly: ${error.message}`);
        }
      }

      // Render all counter instances
      async function renderCounters() {
        // Basic counter
        await client.render(assembly, {
          container: '#basic-counter',
          preset: 'basic',
          onStateChange: updateMetrics,
        });

        // Multiple instances
        await client.render(assembly, {
          container: '#counter-1',
          initialState: { title: 'Counter 1', count: 10 },
        });

        await client.render(assembly, {
          container: '#counter-2',
          initialState: { title: 'Counter 2', count: 20 },
        });

        await client.render(assembly, {
          container: '#counter-3',
          initialState: { title: 'Counter 3', count: 30 },
        });

        // Advanced counter
        await client.render(assembly, {
          container: '#advanced-counter',
          preset: 'advanced',
          onStateChange: updateMetrics,
        });
      }

      // Update metrics
      function updateMetrics(state, action) {
        metrics.totalOperations++;
        document.getElementById('total-operations').textContent =
          metrics.totalOperations;

        if (state.count > metrics.highestValue) {
          metrics.highestValue = state.count;
          document.getElementById('highest-value').textContent =
            metrics.highestValue;
        }

        if (action && action.latency) {
          metrics.lastLatency = action.latency;
          document.getElementById('action-latency').textContent =
            `${action.latency}ms`;
        }
      }

      // Inspect current state
      async function inspectState() {
        const state = await client.getAllState();
        const output = document.getElementById('dev-output');
        output.style.display = 'block';
        output.textContent = JSON.stringify(state, null, 2);
      }

      // Export state
      async function exportState() {
        const state = await client.getAllState();
        const blob = new Blob([JSON.stringify(state, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'counter-state.json';
        a.click();
        showStatus('success', 'State exported successfully!');
      }

      // Reset all counters
      async function resetAll() {
        if (confirm('Are you sure you want to reset all counters?')) {
          await client.resetAllState();
          await renderCounters();
          metrics = { totalOperations: 0, highestValue: 0, lastLatency: 0 };
          updateMetrics({ count: 0 });
          showStatus('success', 'All counters reset!');
        }
      }

      // Show status message
      function showStatus(type, message) {
        const status = document.getElementById('status');
        status.className = `status ${type}`;
        status.textContent = message;

        if (type !== 'loading') {
          setTimeout(() => {
            status.style.display = 'none';
          }, 5000);
        }
      }

      // Mock HashLink client for demo
      class HashLinkClient {
        constructor(config) {
          this.config = config;
          this.state = new Map();
        }

        async initialize() {
          // Mock initialization
          return Promise.resolve();
        }

        async loadAssembly(id) {
          // Mock assembly loading
          return {
            id,
            name: 'Counter Assembly',
            actions: ['counter-action-v1'],
            blocks: ['counter-block-v1'],
          };
        }

        async render(assembly, options) {
          const container = document.querySelector(options.container);
          const blockId = `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

          // Mock rendering
          const initialState =
            options.initialState || options.preset === 'advanced'
              ? {
                  title: 'Advanced Counter',
                  count: 0,
                  step: 5,
                  showMultiply: true,
                  showHistory: true,
                }
              : {
                  title: 'My Counter',
                  count: 0,
                  step: 1,
                  showMultiply: false,
                  showHistory: false,
                };

          this.state.set(blockId, initialState);

          // Render mock UI
          container.innerHTML = this.renderBlock(blockId, initialState);
          this.attachEventHandlers(container, blockId, options.onStateChange);
        }

        renderBlock(blockId, state) {
          return `
                    <div class="wp-block-hashlink-counter" data-block-id="${blockId}">
                        <div class="counter-header">
                            <h3 class="counter-title">${state.title}</h3>
                        </div>
                        <div class="counter-display">
                            <span class="counter-value" data-count="${state.count}">${state.count}</span>
                        </div>
                        <div class="counter-controls">
                            <button class="counter-btn counter-btn-decrease" data-action="decrement">
                                <span class="dashicons dashicons-minus"></span> ${state.step}
                            </button>
                            <button class="counter-btn counter-btn-reset" data-action="reset">
                                <span class="dashicons dashicons-update"></span> Reset
                            </button>
                            <button class="counter-btn counter-btn-increase" data-action="increment">
                                <span class="dashicons dashicons-plus"></span> ${state.step}
                            </button>
                        </div>
                        ${
                          state.showMultiply
                            ? `
                            <div class="counter-multiply">
                                <label>Multiply by:</label>
                                <input type="number" class="multiply-input" value="2" min="1" max="10">
                                <button class="counter-btn counter-btn-multiply" data-action="multiply">
                                    <span class="dashicons dashicons-yes"></span>
                                </button>
                            </div>
                        `
                            : ''
                        }
                    </div>
                `;
        }

        attachEventHandlers(container, blockId, onStateChange) {
          const block = container.querySelector(`[data-block-id="${blockId}"]`);
          const valueDisplay = block.querySelector('.counter-value');

          block.querySelectorAll('.counter-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
              e.preventDefault();

              const action = btn.dataset.action;
              const state = this.state.get(blockId);
              const startTime = Date.now();

              let newCount = state.count;

              switch (action) {
                case 'increment':
                  newCount += state.step;
                  break;
                case 'decrement':
                  newCount -= state.step;
                  break;
                case 'reset':
                  newCount = 0;
                  break;
                case 'multiply':
                  const multiplier = parseInt(
                    block.querySelector('.multiply-input').value,
                  );
                  newCount *= multiplier;
                  break;
              }

              // Update state
              state.count = newCount;
              this.state.set(blockId, state);

              // Update UI
              valueDisplay.textContent = newCount;
              valueDisplay.dataset.count = newCount;

              // Visual feedback
              valueDisplay.classList.add('updating');
              setTimeout(() => valueDisplay.classList.remove('updating'), 300);

              // Call state change handler
              if (onStateChange) {
                onStateChange(state, {
                  action,
                  latency: Date.now() - startTime,
                });
              }
            });
          });
        }

        async getAllState() {
          const state = {};
          this.state.forEach((value, key) => {
            state[key] = value;
          });
          return state;
        }

        async resetAllState() {
          this.state.clear();
        }
      }

      // Load block styles
      const styleSheet = document.createElement('style');
      styleSheet.textContent = `
            .wp-block-hashlink-counter {
                padding: 20px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #fff;
                text-align: center;
            }
            
            .counter-value {
                font-size: 48px;
                font-weight: bold;
                color: #0073aa;
                display: inline-block;
                min-width: 100px;
                transition: all 0.3s ease;
            }
            
            .counter-value.updating {
                transform: scale(1.1);
                color: #00a0d2;
            }
            
            .counter-controls {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin: 20px 0;
            }
            
            .counter-btn {
                display: inline-flex;
                align-items: center;
                gap: 5px;
            }
            
            .counter-btn-decrease {
                background: #d63638;
            }
            
            .counter-btn-decrease:hover {
                background: #b32d2e;
            }
            
            .counter-btn-reset {
                background: #666;
            }
            
            .counter-btn-reset:hover {
                background: #555;
            }
            
            .counter-multiply {
                margin: 20px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            
            .multiply-input {
                width: 60px;
                padding: 5px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
        `;
      document.head.appendChild(styleSheet);

      // Initialize on page load
      window.addEventListener('load', initializeClient);
    </script>
  </body>
</html>
