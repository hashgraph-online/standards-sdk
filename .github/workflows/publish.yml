name: Publish Standards SDK

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'If true, do not publish (use npm/pnpm dry-run)'
        required: false
        default: 'false'

concurrency:
  group: standards-sdk-publish-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  publish:
    name: Release SDK packages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Determine publish plan
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          DRY_RUN="${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'false' }}"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"

          latest_tag="$(git tag --list 'v*' --sort=-version:refname | head -n 1)"
          published_version="$(npm view @hashgraphonline/standards-sdk version 2>/dev/null || true)"
          if [ -n "$published_version" ]; then
            base_version="$published_version"
          else
            base_version="$(node -p "require('./package.json').version")"
          fi

          bump_patch() {
            node -e "const v=process.argv[1].split('.').map(Number); console.log([v[0],v[1],v[2]+1].join('.'))" "$1"
          }

          exists_pkg() {
            npm view "$1@$2" version >/dev/null 2>&1
          }

          mode="release"
          version="$(bump_patch "$base_version")"

          missing=false
          for pkg in "@hashgraphonline/standards-sdk" "@hol-org/standards-sdk" "@hol-org/rb-client"; do
            if ! exists_pkg "$pkg" "$base_version"; then
              missing=true
            fi
          done

          repair_tag=""
          if [ "$missing" = "true" ] && git rev-parse -q --verify "refs/tags/v$base_version" >/dev/null; then
            mode="repair"
            version="$base_version"
            repair_tag="v$base_version"
          fi

          if [ "$mode" = "release" ]; then
            while exists_pkg "@hashgraphonline/standards-sdk" "$version" || exists_pkg "@hol-org/standards-sdk" "$version" || exists_pkg "@hol-org/rb-client" "$version"; do
              version="$(bump_patch "$version")"
            done
          fi

          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"
          echo "latest_tag=${latest_tag:-}" >> "$GITHUB_OUTPUT"
          echo "published_version=${published_version:-}" >> "$GITHUB_OUTPUT"
          echo "repair_tag=$repair_tag" >> "$GITHUB_OUTPUT"

      - name: Checkout release tag (repair mode)
        if: steps.plan.outputs.mode == 'repair' && steps.plan.outputs.repair_tag != ''
        run: git checkout "${{ steps.plan.outputs.repair_tag }}"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm -r run build

      - name: Set versions
        id: version
        shell: bash
        run: |
          set -euo pipefail

          NEW_VERSION="${{ steps.plan.outputs.version }}"
          echo "new=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          pnpm version "$NEW_VERSION" --no-git-tag-version
          NEW_VERSION="$NEW_VERSION" node -e "const fs=require('fs');const p='packages/hol-standards-sdk/package.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version=process.env.NEW_VERSION;fs.writeFileSync(p,JSON.stringify(j,null,2)+'\\n');"
          NEW_VERSION="$NEW_VERSION" node -e "const fs=require('fs');const p='packages/rb-client/package.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version=process.env.NEW_VERSION;fs.writeFileSync(p,JSON.stringify(j,null,2)+'\\n');"

      - name: Compute publish targets
        id: targets
        shell: bash
        run: |
          set -euo pipefail

          NEW_VERSION="${{ steps.version.outputs.new }}"

          exists_pkg() {
            npm view "$1@$NEW_VERSION" version >/dev/null 2>&1
          }

          publish_hash=true
          publish_hol=true
          publish_rb=true

          if exists_pkg "@hashgraphonline/standards-sdk"; then
            publish_hash=false
          fi
          if exists_pkg "@hol-org/standards-sdk"; then
            publish_hol=false
          fi
          if exists_pkg "@hol-org/rb-client"; then
            publish_rb=false
          fi

          publish_any=false
          if [ "$publish_hash" = "true" ] || [ "$publish_hol" = "true" ] || [ "$publish_rb" = "true" ]; then
            publish_any=true
          fi

          echo "publish_hash=$publish_hash" >> "$GITHUB_OUTPUT"
          echo "publish_hol=$publish_hol" >> "$GITHUB_OUTPUT"
          echo "publish_rb=$publish_rb" >> "$GITHUB_OUTPUT"
          echo "publish_any=$publish_any" >> "$GITHUB_OUTPUT"

      - name: Publish @hashgraphonline/standards-sdk
        if: steps.targets.outputs.publish_hash == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.plan.outputs.dry_run }}" = "true" ]; then
            pnpm publish --access public --no-git-checks --provenance --dry-run
          else
            pnpm publish --access public --no-git-checks --provenance
          fi

      - name: Publish @hol-org/standards-sdk
        if: steps.targets.outputs.publish_hol == 'true'
        working-directory: packages/hol-standards-sdk
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.plan.outputs.dry_run }}" = "true" ]; then
            npm publish --access public --provenance --dry-run
          else
            npm publish --access public --provenance
          fi

      - name: Publish @hol-org/rb-client
        if: steps.targets.outputs.publish_rb == 'true'
        working-directory: packages/rb-client
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.plan.outputs.dry_run }}" = "true" ]; then
            npm publish --access public --provenance --dry-run
          else
            npm publish --access public --provenance
          fi

      - name: Publish to JSR
        if: steps.targets.outputs.publish_any == 'true' && (github.event_name != 'workflow_dispatch' || inputs.dry_run != 'true')
        working-directory: packages/jsr-client
        run: |
          # Update jsr.json version to match
          NEW_VERSION="${{ steps.version.outputs.new }}"
          jq --arg v "$NEW_VERSION" '.version = $v' jsr.json > jsr.json.tmp && mv jsr.json.tmp jsr.json
          npx jsr publish --allow-dirty --allow-slow-types

      - name: Create Git tag
        if: steps.plan.outputs.mode == 'release' && steps.targets.outputs.publish_any == 'true' && (github.event_name != 'workflow_dispatch' || inputs.dry_run != 'true')
        run: |
          git tag "v${{ steps.version.outputs.new }}"
          git push --tags

      - name: Skip publish (already published)
        if: steps.targets.outputs.publish_any != 'true'
        run: echo "All packages for version ${{ steps.version.outputs.new }} already exist; skipping publish."
